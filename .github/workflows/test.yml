name: CI

on:
    pull_request:
        branches:
            - main
        paths-ignore:
            - '**.md'
            - '.gitignore'
            - 'LICENSE'
            - 'logo.png'
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: false

jobs:
    Test:
        runs-on: ubuntu-latest
        permissions:
            pull-requests: write
        
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
            
            - name: Set up Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: '3.2'
                  bundler-cache: true
            
            - name: Verify complete.json is valid
              run: |
                  ruby -rjson -e "JSON.parse(File.read('complete.json')); puts '‚úì complete.json is valid JSON'"
            
            - name: Analyze complete.json changes
              id: analyze_changes
              if: github.event_name == 'pull_request'
              run: |
                  git fetch origin main
                  
                  # Check if complete.json changed
                  if git diff --name-only origin/main...HEAD | grep -q "complete.json"; then
                      echo "changed=true" >> $GITHUB_OUTPUT
                      
                      # Get diff stats
                      STATS=$(git diff --shortstat origin/main...HEAD -- complete.json)
                      INSERTIONS=$(echo "$STATS" | grep -oP '\d+(?= insertion)' || echo "0")
                      DELETIONS=$(echo "$STATS" | grep -oP '\d+(?= deletion)' || echo "0")
                      
                      echo "insertions=$INSERTIONS" >> $GITHUB_OUTPUT
                      echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
                      
                      echo "üìä Changes: +$INSERTIONS -$DELETIONS lines"
                  else
                      echo "changed=false" >> $GITHUB_OUTPUT
                      echo "‚ÑπÔ∏è complete.json unchanged"
                  fi
            
            - name: Verify file structure
              run: |
                  echo "üîç Verifying file structure..."
                  
                  # Check complete.min.json
                  if [ ! -f "complete.min.json" ]; then
                      echo "‚ùå Missing: complete.min.json"
                      exit 1
                  fi
                  ruby -rjson -e "JSON.parse(File.read('complete.min.json'))" || exit 1
                  echo "‚úì complete.min.json exists and is valid"
                  
                  # Define expected files
                  MISSING=0
                  INVALID=0
                  
                  for scheme in old new; do
                      if [ "$scheme" = "old" ]; then
                          levels="1 2 3 4 5 6"
                      else
                          levels="1 2 3 4 5 6 7"
                      fi
                      
                      for level in $levels; do
                          for mode in exclusive inclusive; do
                              for ext in json min.json; do
                                  file="wordlists/$mode/$scheme/$level.$ext"
                                  
                                  if [ ! -f "$file" ]; then
                                      echo "‚ùå Missing: $file"
                                      MISSING=$((MISSING + 1))
                                  else
                                      if ! ruby -rjson -e "JSON.parse(File.read('$file'))" 2>/dev/null; then
                                          echo "‚ùå Invalid JSON: $file"
                                          INVALID=$((INVALID + 1))
                                      fi
                                  fi
                              done
                          done
                      done
                  done
                  
                  if [ $MISSING -gt 0 ] || [ $INVALID -gt 0 ]; then
                      echo ""
                      echo "‚ùå File structure validation failed:"
                      echo "   Missing files: $MISSING"
                      echo "   Invalid JSON files: $INVALID"
                      exit 1
                  fi
                  
                  echo "‚úì All 58 expected files exist and contain valid JSON"
            
            - name: Run processing script (dry run)
              run: |
                  ruby scripts/process.rb --dry-run
            